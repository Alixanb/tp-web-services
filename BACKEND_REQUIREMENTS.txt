================================================================================
         SP√âCIFICATIONS BACKEND API - EVENTPASS PLATFORM
              Document pour l'√©quipe Backend
================================================================================

Date: 16 Octobre 2025
Version: 1.0
Stack Backend: NestJS + TypeScript + PostgreSQL
Architecture: REST API + Services SOAP (SOA)

================================================================================
                          TABLE DES MATI√àRES
================================================================================

1. VUE D'ENSEMBLE DU SYST√àME
2. SCH√âMA DE BASE DE DONN√âES (7 TABLES)
3. AUTHENTIFICATION & S√âCURIT√â
4. API REST - ENDPOINTS D√âTAILL√âS (15+)
5. SERVICES SOAP (5 OP√âRATIONS)
6. TYPES DE DONN√âES & FORMATS
7. R√àGLES M√âTIER
8. GESTION DES ERREURS
9. EXEMPLES DE REQU√äTES/R√âPONSES

================================================================================
                      1. VUE D'ENSEMBLE DU SYST√àME
================================================================================

DOMAINE M√âTIER: Plateforme de billetterie en ligne

R√îLES UTILISATEURS:
- CLIENT       : Ach√®te des billets, consulte ses commandes
- ORGANIZER    : Cr√©e/g√®re √©v√©nements, consulte rapports de vente
- ADMIN        : Administration globale, gestion lieux, rapports

COMPOSANTS:
- API REST     : Op√©rations CRUD et recherche
- Services SOAP: Op√©rations critiques/administratives (Reporting, Stocks)
- PostgreSQL   : Base de donn√©es relationnelle

URL BASE API: http://localhost:3000/api

================================================================================
                  2. SCH√âMA DE BASE DE DONN√âES (7 TABLES)
================================================================================

---------------------------------------------
TABLE: users
---------------------------------------------
id              UUID PRIMARY KEY
email           VARCHAR(255) UNIQUE NOT NULL
password        VARCHAR(255) NOT NULL (hashed bcrypt)
firstName       VARCHAR(100) NOT NULL
lastName        VARCHAR(100) NOT NULL
role            ENUM('CLIENT', 'ORGANIZER', 'ADMIN') DEFAULT 'CLIENT'
phoneNumber     VARCHAR(20) NULL
createdAt       TIMESTAMP DEFAULT NOW()
updatedAt       TIMESTAMP DEFAULT NOW()

---------------------------------------------
TABLE: venues (lieux)
---------------------------------------------
id              UUID PRIMARY KEY
name            VARCHAR(255) NOT NULL
address         VARCHAR(255) NOT NULL
city            VARCHAR(100) NOT NULL
postalCode      VARCHAR(20) NOT NULL
country         VARCHAR(100) NOT NULL
capacity        INTEGER NOT NULL
description     TEXT NULL
createdAt       TIMESTAMP DEFAULT NOW()
updatedAt       TIMESTAMP DEFAULT NOW()

---------------------------------------------
TABLE: categories
---------------------------------------------
id              UUID PRIMARY KEY
name            VARCHAR(100) UNIQUE NOT NULL
description     TEXT NULL
icon            VARCHAR(50) NULL
createdAt       TIMESTAMP DEFAULT NOW()
updatedAt       TIMESTAMP DEFAULT NOW()

---------------------------------------------
TABLE: events
---------------------------------------------
id              UUID PRIMARY KEY
title           VARCHAR(255) NOT NULL
description     TEXT NOT NULL
startDate       TIMESTAMP NOT NULL
endDate         TIMESTAMP NOT NULL
status          ENUM('DRAFT', 'PUBLISHED', 'CANCELLED', 'COMPLETED') DEFAULT 'DRAFT'
imageUrl        VARCHAR(500) NULL
venueId         UUID FOREIGN KEY REFERENCES venues(id)
categoryId      UUID FOREIGN KEY REFERENCES categories(id)
organizerId     UUID FOREIGN KEY REFERENCES users(id)
createdAt       TIMESTAMP DEFAULT NOW()
updatedAt       TIMESTAMP DEFAULT NOW()

---------------------------------------------
TABLE: ticket_categories
---------------------------------------------
id              UUID PRIMARY KEY
eventId         UUID FOREIGN KEY REFERENCES events(id) ON DELETE CASCADE
name            VARCHAR(100) NOT NULL (ex: "VIP", "Standard", "Balcon")
price           DECIMAL(10,2) NOT NULL
totalStock      INTEGER NOT NULL
availableStock  INTEGER NOT NULL
description     TEXT NULL
createdAt       TIMESTAMP DEFAULT NOW()
updatedAt       TIMESTAMP DEFAULT NOW()

CONSTRAINT: availableStock <= totalStock

---------------------------------------------
TABLE: orders (commandes)
---------------------------------------------
id              UUID PRIMARY KEY
userId          UUID FOREIGN KEY REFERENCES users(id)
orderDate       TIMESTAMP DEFAULT NOW()
status          ENUM('PENDING', 'RESERVED', 'PAID', 'CANCELLED', 'REFUNDED')
totalAmount     DECIMAL(10,2) NOT NULL
createdAt       TIMESTAMP DEFAULT NOW()
updatedAt       TIMESTAMP DEFAULT NOW()

---------------------------------------------
TABLE: tickets (billets)
---------------------------------------------
id              UUID PRIMARY KEY
orderId         UUID FOREIGN KEY REFERENCES orders(id)
eventId         UUID FOREIGN KEY REFERENCES events(id)
ticketCategoryId UUID FOREIGN KEY REFERENCES ticket_categories(id)
seatNumber      VARCHAR(20) NULL
qrCode          VARCHAR(255) UNIQUE NOT NULL
status          ENUM('ACTIVE', 'USED', 'TRANSFERRED', 'CANCELLED')
price           DECIMAL(10,2) NOT NULL
createdAt       TIMESTAMP DEFAULT NOW()
updatedAt       TIMESTAMP DEFAULT NOW()

================================================================================
                    3. AUTHENTIFICATION & S√âCURIT√â
================================================================================

STRAT√âGIE: JWT (JSON Web Tokens)

TOKEN STRUCTURE:
{
  "userId": "uuid",
  "email": "user@example.com",
  "role": "CLIENT|ORGANIZER|ADMIN",
  "iat": timestamp,
  "exp": timestamp
}

HEADERS REQUIS:
Authorization: Bearer <jwt_token>

DUR√âE DE VIE:
- Access Token: 1 heure
- Refresh Token: 7 jours (optionnel)

HASHING PASSWORD:
- Algorithme: bcrypt
- Salt rounds: 10

PERMISSIONS PAR R√îLE:
CLIENT:
  - GET /events, /events/:id
  - POST /orders
  - GET /orders/:id, /users/:id/orders, /tickets/:id

ORGANIZER:
  - Toutes permissions CLIENT +
  - POST /events, PUT /events/:id, DELETE /events/:id (ses propres √©v√©nements)
  - GET rapports de vente (SOAP) pour ses √©v√©nements

ADMIN:
  - Toutes permissions +
  - POST /venues, PUT /venues/:id, DELETE /venues/:id
  - GET rapports globaux (SOAP)
  - Acc√®s √† toutes les ressources

================================================================================
                4. API REST - ENDPOINTS D√âTAILL√âS (15+)
================================================================================

---------------------------------------------
AUTHENTIFICATION
---------------------------------------------

POST /api/auth/login
Description: Authentification utilisateur
Body: {
  "email": "user@example.com",
  "password": "password123"
}
Response 200: {
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "firstName": "John",
    "lastName": "Doe",
    "role": "CLIENT"
  },
  "token": "jwt_token_here"
}
Errors: 401 (Invalid credentials)

POST /api/users
Description: Cr√©ation de compte
Body: {
  "email": "newuser@example.com",
  "password": "securepass",
  "firstName": "Jane",
  "lastName": "Smith",
  "phoneNumber": "+33612345678",
  "role": "CLIENT"
}
Response 201: { user, token }
Errors: 400 (Email already exists), 422 (Validation error)

---------------------------------------------
√âV√âNEMENTS
---------------------------------------------

GET /api/events
Description: Recherche et filtrage des √©v√©nements
Query Params:
  - search: string (titre, description)
  - categoryId: uuid
  - city: string
  - startDate: ISO date
  - endDate: ISO date
  - minPrice: number
  - maxPrice: number
  - status: PUBLISHED (par d√©faut pour clients)
Response 200: Event[]
Include: venue, category, organizer, ticketCategories

GET /api/events/:id
Description: D√©tails d'un √©v√©nement
Response 200: Event (avec relations compl√®tes)
Errors: 404 (Event not found)

POST /api/events
Auth: ORGANIZER, ADMIN
Body: {
  "title": "Concert de Jazz",
  "description": "Une soir√©e exceptionnelle",
  "startDate": "2025-11-15T20:00:00Z",
  "endDate": "2025-11-15T23:00:00Z",
  "imageUrl": "https://...",
  "venueId": "uuid",
  "categoryId": "uuid",
  "ticketCategories": [
    {
      "name": "VIP",
      "price": 50.00,
      "totalStock": 100,
      "description": "Acc√®s backstage"
    },
    {
      "name": "Standard",
      "price": 25.00,
      "totalStock": 500
    }
  ]
}
Response 201: Event
Errors: 403 (Forbidden), 422 (Validation)

PUT /api/events/:id
Auth: ORGANIZER (owner), ADMIN
Body: Partial<Event>
Response 200: Event
Errors: 403 (Not owner), 404 (Not found)

DELETE /api/events/:id
Auth: ORGANIZER (owner), ADMIN
Response 204: No Content
Errors: 403 (Forbidden), 404 (Not found)
Note: V√©rifier qu'il n'y a pas de billets vendus

---------------------------------------------
COMMANDES
---------------------------------------------

POST /api/orders
Auth: CLIENT, ORGANIZER, ADMIN
Body: {
  "items": [
    {
      "ticketCategoryId": "uuid",
      "quantity": 2,
      "price": 50.00
    }
  ]
}
WORKFLOW:
1. V√©rifier disponibilit√© stock
2. Cr√©er commande avec status PENDING
3. R√©server stock (availableStock -= quantity)
4. G√©n√©rer QR codes pour chaque billet
5. Simuler paiement (ou int√©grer Stripe)
6. Si succ√®s: status = PAID, cr√©er tickets
7. Si √©chec: lib√©rer stock, status = CANCELLED

Response 201: {
  "order": Order,
  "tickets": Ticket[]
}
Errors: 400 (Insufficient stock), 422 (Invalid data)

GET /api/orders/:id
Auth: Owner, ORGANIZER (if event owner), ADMIN
Response 200: Order (avec tickets)
Errors: 403 (Forbidden), 404 (Not found)

GET /api/users/:userId/orders
Auth: User himself, ADMIN
Description: Historique des commandes
Response 200: Order[]

---------------------------------------------
BILLETS
---------------------------------------------

GET /api/tickets/:id
Auth: Owner, ORGANIZER (event owner), ADMIN
Response 200: Ticket (avec event, order)
Errors: 403, 404

GET /api/orders/:orderId/tickets
Auth: Order owner, ORGANIZER, ADMIN
Response 200: Ticket[]

PUT /api/tickets/:id
Auth: Owner, ORGANIZER, ADMIN
Body: {
  "status": "USED" | "TRANSFERRED" | "CANCELLED",
  "seatNumber": "A12"
}
Response 200: Ticket
Note: Validation QR code lors du changement √† USED

---------------------------------------------
LIEUX (ADMIN ONLY)
---------------------------------------------

GET /api/venues
Response 200: Venue[]

GET /api/venues/:id
Response 200: Venue
Errors: 404

POST /api/venues
Auth: ADMIN
Body: {
  "name": "Zenith de Paris",
  "address": "211 Avenue Jean Jaur√®s",
  "city": "Paris",
  "postalCode": "75019",
  "country": "France",
  "capacity": 6293,
  "description": "Grande salle de spectacle"
}
Response 201: Venue

PUT /api/venues/:id
Auth: ADMIN
Body: Partial<Venue>
Response 200: Venue

DELETE /api/venues/:id
Auth: ADMIN
Response 204
Note: V√©rifier qu'aucun √©v√©nement n'utilise ce lieu

---------------------------------------------
UTILISATEURS
---------------------------------------------

GET /api/users/:id
Auth: User himself, ADMIN
Response 200: User (sans password)

PUT /api/users/:id
Auth: User himself, ADMIN
Body: {
  "firstName": "Updated",
  "lastName": "Name",
  "phoneNumber": "+33..."
}
Response 200: User

GET /api/users
Auth: ADMIN
Response 200: User[]

---------------------------------------------
CAT√âGORIES
---------------------------------------------

GET /api/categories
Response 200: Category[]

GET /api/categories/:id
Response 200: Category

POST /api/categories
Auth: ADMIN
Body: {
  "name": "Musique",
  "description": "√âv√©nements musicaux",
  "icon": "music"
}
Response 201: Category

================================================================================
                    5. SERVICES SOAP (5 OP√âRATIONS)
================================================================================

NAMESPACE: http://eventpass.com/soap/v1
ENDPOINT: http://localhost:3000/soap

---------------------------------------------
OP√âRATION 1: generateSaleReport
---------------------------------------------
Description: G√©n√®re un rapport de vente d√©taill√© pour un √©v√©nement
Auth: ORGANIZER (owner), ADMIN

INPUT:
<generateSaleReport>
  <eventId>uuid</eventId>
  <startDate>2025-01-01</startDate>
  <endDate>2025-12-31</endDate>
</generateSaleReport>

OUTPUT:
<SalesReport>
  <eventId>uuid</eventId>
  <eventTitle>Concert de Jazz</eventTitle>
  <totalRevenue>12500.00</totalRevenue>
  <ticketsSold>250</ticketsSold>
  <ticketsByCategory>
    <category>
      <categoryName>VIP</categoryName>
      <sold>50</sold>
      <revenue>2500.00</revenue>
    </category>
    <category>
      <categoryName>Standard</categoryName>
      <sold>200</sold>
      <revenue>10000.00</revenue>
    </category>
  </ticketsByCategory>
  <reportDate>2025-10-16T10:30:00Z</reportDate>
</SalesReport>

LOGIQUE:
- Agr√©ger toutes les commandes PAID pour l'√©v√©nement
- Calculer revenu total par cat√©gorie
- Compter billets vendus

---------------------------------------------
OP√âRATION 2: updateTicketStock
---------------------------------------------
Description: Mise √† jour manuelle et critique du stock (admin)
Auth: ADMIN

INPUT:
<updateTicketStock>
  <ticketCategoryId>uuid</ticketCategoryId>
  <newTotalStock>600</newTotalStock>
  <reason>Ajout de places suite √† demande</reason>
</updateTicketStock>

OUTPUT:
<UpdateStockResponse>
  <success>true</success>
  <ticketCategoryId>uuid</ticketCategoryId>
  <previousStock>500</previousStock>
  <newStock>600</newStock>
  <timestamp>2025-10-16T10:30:00Z</timestamp>
</UpdateStockResponse>

LOGIQUE:
- V√©rifier que newStock >= tickets d√©j√† vendus
- Mettre √† jour totalStock et availableStock
- Logger l'action (audit trail)

---------------------------------------------
OP√âRATION 3: processRefund
---------------------------------------------
Description: Processus de remboursement pour une commande
Auth: ORGANIZER (owner), ADMIN

INPUT:
<processRefund>
  <orderId>uuid</orderId>
  <reason>√âv√©nement annul√©</reason>
</processRefund>

OUTPUT:
<RefundResponse>
  <success>true</success>
  <orderId>uuid</orderId>
  <refundAmount>100.00</refundAmount>
  <ticketsRefunded>2</ticketsRefunded>
  <timestamp>2025-10-16T10:30:00Z</timestamp>
</RefundResponse>

LOGIQUE:
- V√©rifier que commande est PAID
- Changer status commande √† REFUNDED
- Changer status billets √† CANCELLED
- Lib√©rer le stock (availableStock += quantity)
- Appeler service paiement externe (simulation)

---------------------------------------------
OP√âRATION 4: getVenueCapacity
---------------------------------------------
Description: R√©cup√®re la capacit√© et statistiques d'un lieu
Auth: ORGANIZER, ADMIN

INPUT:
<getVenueCapacity>
  <venueId>uuid</venueId>
</getVenueCapacity>

OUTPUT:
<VenueCapacityReport>
  <venueId>uuid</venueId>
  <venueName>Zenith de Paris</venueName>
  <totalCapacity>6293</totalCapacity>
  <upcomingEvents>12</upcomingEvents>
  <averageOccupancyRate>85.5</averageOccupancyRate>
</VenueCapacityReport>

---------------------------------------------
OP√âRATION 5: logAdminAction
---------------------------------------------
Description: Enregistrement forc√© d'actions administratives (audit)
Auth: SYSTEM (appel√© automatiquement)

INPUT:
<logAdminAction>
  <adminId>uuid</adminId>
  <action>DELETE_VENUE</action>
  <targetId>uuid</targetId>
  <metadata>
    <key>reason</key>
    <value>Lieu ferm√© d√©finitivement</value>
  </metadata>
  <timestamp>2025-10-16T10:30:00Z</timestamp>
</logAdminAction>

OUTPUT:
<LogResponse>
  <logged>true</logged>
  <logId>uuid</logId>
</LogResponse>

NOTE: Cr√©er table audit_logs pour tra√ßabilit√©

================================================================================
                    6. TYPES DE DONN√âES & FORMATS
================================================================================

DATES:
Format: ISO 8601 (YYYY-MM-DDTHH:mm:ssZ)
Timezone: UTC
Exemple: "2025-11-15T20:00:00Z"

PRIX:
Type: Decimal(10,2)
Format JSON: number
Exemple: 49.99

UUID:
Format: v4 (ex: "550e8400-e29b-41d4-a716-446655440000")

QR CODE:
Format: UUID + timestamp hash√©
Exemple: "EVT_550e8400_1698234000_a3f9c2"
G√©n√©rateur: crypto.randomBytes(32).toString('hex')

PAGINATION (optionnel mais recommand√©):
Query params: ?page=1&limit=20
Response headers:
  X-Total-Count: 156
  X-Page: 1
  X-Per-Page: 20

================================================================================
                         7. R√àGLES M√âTIER
================================================================================

GESTION DES STOCKS:
- R√©servation temporaire pendant 15 minutes lors de la cr√©ation de commande
- Transaction atomique: v√©rifier stock -> r√©server -> cr√©er commande -> billets
- Si paiement √©choue: lib√©rer automatiquement le stock

VALIDATION DES √âV√âNEMENTS:
- startDate doit √™tre dans le futur lors de la cr√©ation
- endDate > startDate
- Venue capacity >= sum(totalStock) de toutes les ticket_categories

ACHATS:
- Un utilisateur peut acheter max 10 billets par commande
- Prix du billet doit correspondre au prix actuel de la cat√©gorie
- V√©rifier que l'√©v√©nement n'est pas CANCELLED

REMBOURSEMENTS:
- Possible jusqu'√† 48h avant le d√©but de l'√©v√©nement
- Commission de 5% retenue (optionnel)
- Notification email obligatoire

ORGANISATEURS:
- Ne peuvent modifier/supprimer que leurs propres √©v√©nements
- Peuvent voir toutes les commandes de leurs √©v√©nements
- Acc√®s aux rapports de vente uniquement pour leurs √©v√©nements

================================================================================
                      8. GESTION DES ERREURS
================================================================================

CODES HTTP:
200 OK              - Succ√®s
201 Created         - Ressource cr√©√©e
204 No Content      - Suppression r√©ussie
400 Bad Request     - Donn√©es invalides
401 Unauthorized    - Non authentifi√©
403 Forbidden       - Pas les permissions
404 Not Found       - Ressource inexistante
409 Conflict        - Conflit (ex: email existe)
422 Unprocessable   - Validation m√©tier √©chou√©e
500 Internal Error  - Erreur serveur

FORMAT ERREUR:
{
  "statusCode": 400,
  "message": "Insufficient stock for ticket category VIP",
  "error": "Bad Request",
  "timestamp": "2025-10-16T10:30:00Z",
  "path": "/api/orders"
}

MESSAGES CLAIRS:
‚úì "Insufficient stock. Only 5 tickets available"
‚úó "Stock error"

VALIDATION:
- Utiliser class-validator avec DTO
- Messages d'erreur en fran√ßais c√¥t√© frontend
- Logs d√©taill√©s c√¥t√© backend

================================================================================
                   9. EXEMPLES REQU√äTE/R√âPONSE
================================================================================

---------------------------------------------
EXEMPLE 1: Recherche d'√©v√©nements
---------------------------------------------

REQUEST:
GET /api/events?city=Paris&categoryId=uuid&minPrice=20&maxPrice=100
Authorization: Bearer eyJhbGc...

RESPONSE 200:
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "Concert de Jazz en Plein Air",
    "description": "Une soir√©e exceptionnelle...",
    "startDate": "2025-11-15T20:00:00Z",
    "endDate": "2025-11-15T23:00:00Z",
    "status": "PUBLISHED",
    "imageUrl": "https://cdn.example.com/events/jazz.jpg",
    "venue": {
      "id": "...",
      "name": "Parc de la Villette",
      "city": "Paris",
      "capacity": 5000
    },
    "category": {
      "id": "...",
      "name": "Musique",
      "icon": "music"
    },
    "organizer": {
      "id": "...",
      "firstName": "John",
      "lastName": "Doe"
    },
    "ticketCategories": [
      {
        "id": "...",
        "name": "VIP",
        "price": 50.00,
        "totalStock": 100,
        "availableStock": 75
      },
      {
        "id": "...",
        "name": "Standard",
        "price": 25.00,
        "totalStock": 500,
        "availableStock": 450
      }
    ],
    "createdAt": "2025-10-01T10:00:00Z",
    "updatedAt": "2025-10-15T14:30:00Z"
  }
]

---------------------------------------------
EXEMPLE 2: Cr√©ation de commande
---------------------------------------------

REQUEST:
POST /api/orders
Authorization: Bearer eyJhbGc...
Content-Type: application/json

{
  "items": [
    {
      "ticketCategoryId": "cat-vip-uuid",
      "quantity": 2,
      "price": 50.00
    }
  ]
}

RESPONSE 201:
{
  "order": {
    "id": "order-uuid",
    "userId": "user-uuid",
    "orderDate": "2025-10-16T10:30:00Z",
    "status": "PAID",
    "totalAmount": 100.00
  },
  "tickets": [
    {
      "id": "ticket-1-uuid",
      "orderId": "order-uuid",
      "eventId": "event-uuid",
      "ticketCategoryId": "cat-vip-uuid",
      "qrCode": "EVT_550e8400_1698234000_a3f9c2",
      "status": "ACTIVE",
      "price": 50.00,
      "event": {
        "title": "Concert de Jazz",
        "startDate": "2025-11-15T20:00:00Z",
        "venue": {
          "name": "Parc de la Villette",
          "address": "211 Avenue Jean Jaur√®s",
          "city": "Paris"
        }
      }
    },
    {
      "id": "ticket-2-uuid",
      ...
    }
  ]
}

================================================================================
                          NOTES TECHNIQUES
================================================================================

PERFORMANCE:
- Indexer: events(startDate), orders(userId, status), tickets(qrCode)
- Utiliser transactions PostgreSQL pour les achats
- Cache Redis pour les recherches fr√©quentes (optionnel)

S√âCURIT√â:
- Valider TOUTES les entr√©es utilisateur
- Rate limiting: 100 req/min par IP
- CORS configur√© pour https://eventpass.com
- Helmet.js pour headers s√©curis√©s
- Logs d'audit pour actions ADMIN

TESTING:
- Unit tests: Services m√©tier
- Integration tests: Endpoints API
- E2E tests: Workflow complet achat de billet

D√âPLOIEMENT:
- Docker + Docker Compose
- Variables d'environnement: .env
- Migrations de BDD avec TypeORM

================================================================================
                     CONTACT & PROCHAINES √âTAPES
================================================================================

PRIORIT√âS D√âVELOPPEMENT:
1. Setup base de donn√©es PostgreSQL (7 tables)
2. Authentification JWT
3. CRUD √âv√©nements + Recherche
4. Workflow Commandes (avec gestion stock)
5. Services SOAP pour reporting
6. Tests & Documentation

QUESTIONS?
Contacter l'√©quipe Frontend pour clarifications sur les types et formats.

Toute la structure TypeScript est disponible dans:
/frontend/src/types/*

Bon d√©veloppement! üöÄ

================================================================================

